<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faster simulation using revdbayes • revdbayes</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Faster simulation using revdbayes">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">revdbayes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.3.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/revdbayes-a-vignette.html">Introducing revdbayes: Ratio-of-Uniforms Sampling for Bayesian Extreme Value Analysis</a>
    </li>
    <li>
      <a href="../articles/revdbayes-b-using-rcpp-vignette.html">Faster simulation using revdbayes</a>
    </li>
    <li>
      <a href="../articles/revdbayes-c-predictive-vignette.html">Posterior Predictive Extreme Value Inference using the revdbayes Package</a>
    </li>
    <li>
      <a href="../articles/revdbayes-d-kgaps-vignette.html">Inference for the extremal index using the K-gaps model</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/paulnorthrop/revdbayes">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Faster simulation using revdbayes</h1>
                        <h4 class="author">Paul J. Northrop</h4>
            
            <h4 class="date">2019-11-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/paulnorthrop/revdbayes/blob/master/vignettes/revdbayes-b-using-rcpp-vignette.Rmd"><code>vignettes/revdbayes-b-using-rcpp-vignette.Rmd</code></a></small>
      <div class="hidden name"><code>revdbayes-b-using-rcpp-vignette.Rmd</code></div>

    </div>

    
    
<p>This vignette introduces a new feature of <em>revdbayes</em>: reducing posterior simulation time by performing the most time-consuming tasks using C++ functions. This achieved using a new facility in the <em>rust</em> package <span class="citation">(Northrop 2017)</span>, which in turn uses the <strong>Rcpp</strong> package <span class="citation">(Eddelbuettel and Francois 2011, <span class="citation">Eddelbuettel (2013)</span>)</span>. The result is a new function <code>rpost_rcpp</code>, which has the same structure as the existing function <code>rpost</code>. From a user’s perspective the only difference between these two functions occurs if they wish to supply their own prior distribution: <code>rpost_rcpp</code> requires an external pointer to a C++ function (see <a href="#cpp_fun">Providing a user-defined prior</a>), whereas <code>rpost</code> requires an input R function (see the vignette <a href="revdbayes-a-vignette.html">Introducing revdbayes</a>.</p>
<p>Before we deal with user-supplied priors we compare posterior simulation times using <code>rpost</code> and <code>rpost_rcpp</code> for examples based on in-built prior distributions. We use the default settings of <code>rpost</code> and <code>rpost_rcpp</code> throughout. We also compare the speed of these functions with the function <code>posterior</code> in the <strong>evdbayes</strong> package <span class="citation">(Stephenson and Ribatet 2014)</span>, using the <strong>microbenchmark</strong> package <span class="citation">(Mersmann 2015)</span>.</p>
<div id="performance-comparisons" class="section level2">
<h2 class="hasAnchor">
<a href="#performance-comparisons" class="anchor"></a>Performance comparisons</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(revdbayes)
<span class="co"># Are microbenchmark and evdbayes available?</span>
got_microbenchmark &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span>(<span class="st">"microbenchmark"</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)
got_evdbayes &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span>(<span class="st">"evdbayes"</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)
<span class="cf">if</span> (got_microbenchmark) {
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(microbenchmark)
}
<span class="cf">if</span> (got_evdbayes) {
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(evdbayes)
}
<span class="co"># Set the number of posterior samples required.</span>
n &lt;-<span class="st"> </span><span class="dv">1000</span>
<span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">46</span>)</code></pre></div>
<div id="gp_example" class="section level3">
<h3 class="hasAnchor">
<a href="#gp_example" class="anchor"></a>Generalised Pareto (GP) model</h3>
<p>We repeat the analysis of the Gulf of Mexico Wave Height Data from the <a href="revdbayes-a-vignette.html">Introducing revdbayes</a> vignette to check that using Rcpp does indeed reduce computation time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">u &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(gom, <span class="dt">probs =</span> <span class="fl">0.65</span>)
fp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/set_prior.html">set_prior</a></span>(<span class="dt">prior =</span> <span class="st">"flat"</span>, <span class="dt">model =</span> <span class="st">"gp"</span>, <span class="dt">min_xi =</span> <span class="op">-</span><span class="dv">1</span>)
<span class="cf">if</span> (got_microbenchmark) {
  res &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(
    <span class="dt">rpost =</span> <span class="kw"><a href="../reference/rpost.html">rpost</a></span>(<span class="dt">n =</span> n, <span class="dt">model =</span> <span class="st">"gp"</span>, <span class="dt">prior =</span> fp, <span class="dt">thresh =</span> u, <span class="dt">data =</span> gom),
    <span class="dt">rpost_rcpp =</span> <span class="kw"><a href="../reference/rpost_rcpp.html">rpost_rcpp</a></span>(<span class="dt">n =</span> n, <span class="dt">model =</span> <span class="st">"gp"</span>, <span class="dt">prior =</span> fp, <span class="dt">thresh =</span> u, 
                            <span class="dt">data =</span>   gom)
  )
  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(res, <span class="dt">signif =</span> <span class="dv">3</span>)
  <span class="kw"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="dt">microbenchmark.unit =</span> <span class="st">"relative"</span>)
  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(res, <span class="dt">signif =</span> <span class="dv">2</span>)
}  
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;        expr   min    lq  mean median    uq   max neval</span>
<span class="co">#&gt;       rpost 103.0 121.0 151.0  147.0 171.0 251.0   100</span>
<span class="co">#&gt;  rpost_rcpp  18.6  20.5  26.3   24.3  31.4  58.4   100</span>
<span class="co">#&gt; Unit: relative</span>
<span class="co">#&gt;        expr min  lq mean median  uq max neval</span>
<span class="co">#&gt;       rpost 5.6 5.9  5.7    6.1 5.4 4.3   100</span>
<span class="co">#&gt;  rpost_rcpp 1.0 1.0  1.0    1.0 1.0 1.0   100</span></code></pre></div>
<p>In this example <code>rpost_rcpp</code> is indeed much faster than <code>rpost</code>.</p>
</div>
<div id="generalised-extreme-value-gev-model" class="section level3">
<h3 class="hasAnchor">
<a href="#generalised-extreme-value-gev-model" class="anchor"></a>Generalised Extreme Value (GEV) model</h3>
<p>We repeat the analysis of the Port Pirie annual maximum sea level data from the <a href="revdbayes-a-vignette.html">Introducing revdbayes</a>. We add to the comparison the example calculations that feature in the <strong>evdbayes</strong> user guide, based on the <code>posterior</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">10000</span>, <span class="dv">10000</span>, <span class="dv">100</span>))
pn &lt;-<span class="st"> </span><span class="kw"><a href="../reference/set_prior.html">set_prior</a></span>(<span class="dt">prior =</span> <span class="st">"norm"</span>, <span class="dt">model =</span> <span class="st">"gev"</span>, <span class="dt">mean =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">cov =</span> mat)
<span class="co"># Tuning parameters from the evdbayes user guide.</span>
t0 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3.87</span>, <span class="fl">0.2</span>, <span class="op">-</span><span class="fl">0.05</span>) 
s &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(.<span class="dv">06</span>, .<span class="dv">25</span>, .<span class="dv">25</span>)
<span class="cf">if</span> (got_microbenchmark) {
  <span class="cf">if</span> (got_evdbayes) {
    res &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(
      <span class="dt">rpost =</span> <span class="kw"><a href="../reference/rpost.html">rpost</a></span>(<span class="dt">n =</span> n, <span class="dt">model =</span> <span class="st">"gev"</span>, <span class="dt">prior =</span> pn, <span class="dt">data =</span> portpirie),
      <span class="dt">rpost_rcpp =</span> <span class="kw"><a href="../reference/rpost_rcpp.html">rpost_rcpp</a></span>(<span class="dt">n =</span> n, <span class="dt">model =</span> <span class="st">"gev"</span>, <span class="dt">prior =</span> pn, 
                            <span class="dt">data =</span> portpirie),
      <span class="dt">evdbayes =</span> <span class="kw">posterior</span>(<span class="dt">n =</span> n, <span class="dt">init =</span> t0, <span class="dt">prior =</span> pn, <span class="dt">lh =</span> <span class="st">"gev"</span>, 
                         <span class="dt">data =</span> portpirie, <span class="dt">psd =</span> s, <span class="dt">burn =</span> <span class="dv">0</span>)
    )
  } <span class="cf">else</span> {
    res &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(
      <span class="dt">rpost =</span> <span class="kw"><a href="../reference/rpost.html">rpost</a></span>(<span class="dt">n =</span> n, <span class="dt">model =</span> <span class="st">"gev"</span>, <span class="dt">prior =</span> pn, <span class="dt">data =</span> portpirie),
      <span class="dt">rpost_rcpp =</span> <span class="kw"><a href="../reference/rpost_rcpp.html">rpost_rcpp</a></span>(<span class="dt">n =</span> n, <span class="dt">model =</span> <span class="st">"gev"</span>, <span class="dt">prior =</span> pn, 
                              <span class="dt">data =</span> portpirie)
    )
  }
  <span class="kw"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="dt">microbenchmark.unit =</span> <span class="ot">NULL</span>)
  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(res, <span class="dt">signif =</span> <span class="dv">3</span>)
  <span class="kw"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="dt">microbenchmark.unit =</span> <span class="st">"relative"</span>)
  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(res, <span class="dt">signif =</span> <span class="dv">2</span>)
}  
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;        expr   min    lq  mean median    uq max neval</span>
<span class="co">#&gt;       rpost 248.0 293.0 328.0  313.0 341.0 884   100</span>
<span class="co">#&gt;  rpost_rcpp  65.7  71.4  78.5   75.2  83.6 113   100</span>
<span class="co">#&gt;    evdbayes 196.0 217.0 242.0  232.0 254.0 484   100</span>
<span class="co">#&gt; Unit: relative</span>
<span class="co">#&gt;        expr min  lq mean median  uq max neval</span>
<span class="co">#&gt;       rpost 3.8 4.1  4.2    4.2 4.1 7.8   100</span>
<span class="co">#&gt;  rpost_rcpp 1.0 1.0  1.0    1.0 1.0 1.0   100</span>
<span class="co">#&gt;    evdbayes 3.0 3.0  3.1    3.1 3.0 4.3   100</span></code></pre></div>
<p>This comparison is generous to <code>posterior</code> because the burn-in has been set to zero and <code>posterior</code> produces a dependent sample rather than a random sample. The <em>effective sample size</em> of an MCMC sample from <code>posterior</code> varies between simulations and across parameters. The <code>effectiveSize</code> function in the <strong>coda</strong> package <span class="citation">(Plummer et al. 2006)</span> suggests that the effective sample size in this example is of the order of 100 to 200, whereas the <strong>revdbayes</strong> functions <code>rpost</code> and <code>rpost_rcpp</code> produce random samples of size 1000. <code>rpost</code> is a little slower than <code>posterior</code> while <code>rpost_rcpp</code> is much faster than <code>posterior</code>.</p>
</div>
<div id="point-process-pp-model" class="section level3">
<h3 class="hasAnchor">
<a href="#point-process-pp-model" class="anchor"></a>Point Process (PP) model</h3>
<p>We compare the computational efficiencies of <code>rpost</code>, <code>rpost_rcpp</code> and the evdbayes function <code>posterior</code> when performing the analysis of daily rainfall totals from the <a href="revdbayes-a-vignette.html">Introducing revdbayes</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Informative prior set using revdbayes</span>
pr2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/set_prior.html">set_prior</a></span>(<span class="dt">prob =</span> <span class="dv">10</span><span class="op">^-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="dt">shape =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">38.9</span>, <span class="fl">7.1</span>, <span class="dv">47</span>),
                 <span class="dt">scale =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1.5</span>, <span class="fl">6.3</span>, <span class="fl">2.6</span>), <span class="dt">model =</span> <span class="st">"gev"</span>, <span class="dt">prior =</span> <span class="st">"quant"</span>)
<span class="co"># Tuning parameters from the evdbayes user guide.</span>
t0 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">43.2</span>, <span class="fl">7.64</span>, <span class="fl">0.32</span>) 
s &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2</span>, .<span class="dv">2</span>, .<span class="dv">07</span>)
<span class="cf">if</span> (got_microbenchmark) {
  <span class="cf">if</span> (got_evdbayes) {
    <span class="co"># Informative prior set using evdbayes</span>
    pr &lt;-<span class="st"> </span><span class="kw">prior.quant</span>(<span class="dt">prob =</span> <span class="dv">10</span><span class="op">^-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="dt">shape =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">38.9</span>, <span class="fl">7.1</span>, <span class="dv">47</span>), 
                      <span class="dt">scale =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1.5</span>, <span class="fl">6.3</span>, <span class="fl">2.6</span>))
    res &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(
      <span class="dt">rpost =</span> <span class="kw"><a href="../reference/rpost.html">rpost</a></span>(<span class="dt">n =</span> n, <span class="dt">model =</span> <span class="st">"pp"</span>, <span class="dt">prior =</span> pr2, <span class="dt">data =</span> rainfall,
                <span class="dt">thresh =</span> <span class="dv">40</span>, <span class="dt">noy =</span> <span class="dv">54</span>),
      <span class="dt">rpost_rcpp =</span> <span class="kw"><a href="../reference/rpost_rcpp.html">rpost_rcpp</a></span>(<span class="dt">n =</span> n, <span class="dt">model =</span> <span class="st">"pp"</span>, <span class="dt">prior =</span> pr2, <span class="dt">data =</span> rainfall,
                          <span class="dt">thresh =</span> <span class="dv">40</span>, <span class="dt">noy =</span> <span class="dv">54</span>),
      <span class="dt">evdbayes =</span> <span class="kw">posterior</span>(<span class="dt">n =</span> n, <span class="dt">init =</span> t0, <span class="dt">prior =</span> pr, <span class="st">"pp"</span>, <span class="dt">data =</span> rainfall,
                       <span class="dt">thresh =</span> <span class="dv">40</span>, <span class="dt">noy =</span> <span class="dv">54</span>, <span class="dt">psd =</span> s, <span class="dt">burn =</span> <span class="dv">0</span>)
    )
  } <span class="cf">else</span> {
    res &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(
      <span class="dt">rpost =</span> <span class="kw"><a href="../reference/rpost.html">rpost</a></span>(<span class="dt">n =</span> n, <span class="dt">model =</span> <span class="st">"pp"</span>, <span class="dt">prior =</span> pr2, <span class="dt">data =</span> rainfall,
                <span class="dt">thresh =</span> <span class="dv">40</span>, <span class="dt">noy =</span> <span class="dv">54</span>),
      <span class="dt">rpost_rcpp =</span> <span class="kw"><a href="../reference/rpost_rcpp.html">rpost_rcpp</a></span>(<span class="dt">n =</span> n, <span class="dt">model =</span> <span class="st">"pp"</span>, <span class="dt">prior =</span> pr2, <span class="dt">data =</span> rainfall,
                          <span class="dt">thresh =</span> <span class="dv">40</span>, <span class="dt">noy =</span> <span class="dv">54</span>)
    )
  }  
  <span class="kw"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="dt">microbenchmark.unit =</span> <span class="ot">NULL</span>)
  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(res, <span class="dt">signif =</span> <span class="dv">3</span>)
  <span class="kw"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="dt">microbenchmark.unit =</span> <span class="st">"relative"</span>)
  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(res, <span class="dt">signif =</span> <span class="dv">2</span>)
}  
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;        expr   min    lq  mean median    uq    max neval</span>
<span class="co">#&gt;       rpost 462.0 538.0 629.0  579.0 684.0 1040.0   100</span>
<span class="co">#&gt;  rpost_rcpp  39.7  45.8  55.7   50.3  61.4   93.9   100</span>
<span class="co">#&gt;    evdbayes 256.0 281.0 330.0  315.0 369.0  559.0   100</span>
<span class="co">#&gt; Unit: relative</span>
<span class="co">#&gt;        expr  min   lq mean median uq  max neval</span>
<span class="co">#&gt;       rpost 12.0 12.0 11.0   11.0 11 11.0   100</span>
<span class="co">#&gt;  rpost_rcpp  1.0  1.0  1.0    1.0  1  1.0   100</span>
<span class="co">#&gt;    evdbayes  6.5  6.1  5.9    6.3  6  5.9   100</span></code></pre></div>
<p>In this example <code>rpost</code> is slower than <code>posterior</code> but <code>rpost_rcpp</code> is substantially faster than <code>posterior</code>.</p>
</div>
</div>
<div id="cpp_fun" class="section level2">
<h2 class="hasAnchor">
<a href="#cpp_fun" class="anchor"></a>Providing a user-defined prior</h2>
<p>If the user wishes to supply their own prior to <code>rpost_rcpp</code> then they must first write a C++ function that evaluates the log of the prior density. The general way that <strong>rust</strong> (and hence <strong>revdbayes</strong>) enables users to provide their own C++ log-prior functions uses external pointers and is based on the <a href="http://gallery.rcpp.org/">Rcpp Gallery</a> article <a href="http://gallery.rcpp.org/articles/passing-cpp-function-pointers/">Passing user-supplied C++ functions</a> by Dirk Eddelbuettel.</p>
<p>The implementation in <strong>rust</strong> requires this C++ function to have a particular structure: it must take a constant reference to an <code>Rcpp::NumericVector</code>, say <code>x</code>, a constant reference to an <code>Rcpp::List</code>, say <code>ppars</code>, and return a <code>double</code> precision scalar. Here <code>x</code> is the argument of the prior density, i.e. the parameter vector of the extreme value model, and <code>ppars</code> is a list containing the values of prior parameters whose values are not specified inside the function. Thus values of any parameters in the prior can be changed without editing the function. If there are no such parameters then the argument <code>ppars</code> must still be present in the C++ function, even though the list provided to the function will be empty.</p>
<p>A simple way to provide C++ log-prior functions is to put them in a file, say <code>user_fns.cpp</code>, perhaps taking advantage of the R-like syntax made available by <a href="http://dirk.eddelbuettel.com/code/rcpp/Rcpp-sugar.pdf">Rcpp sugar</a>. Example content is provided below. This file is available on the <a href="https://github.com/paulnorthrop/revdbayes/blob/master/src/user_priors.cpp">revdbayes Github page</a>.The functions in this file are compiled and made available to R, either using the <code><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">Rcpp::sourceCpp</a></code> function (e.g. <code><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">Rcpp::sourceCpp("user_fns.cpp")</a></code>) or using RStudio’s Source button on the editor toolbar. The example content below also includes the function <code>create_prior_xptr</code>, which creates an external pointer to a C++ function. See . It is this external pointer that is passed to <code>set_prior</code> to set the prior. If the user has written a C++ function, say <code>new_name</code>, they need to add to <code>create_prior_xptr</code> two lines of code:</p>
<pre><code>else if (fstr == "new_name")  
  return(Rcpp::XPtr&lt;funcPtr&gt;(new funcPtr(&amp;new_name))) ;</code></pre>
<p>in order that they can create an external pointer for <code>new_name</code> using <code>create_xptr</code>.</p>
<p>The following excerpt from the example <code>user_fns.cpp</code> file contains a C++ function <code>user_gp_flat</code> to evaluate (the log of) a prior density <span class="math inline">\(\pi(\sigma, \xi) \propto \sigma^{-1}, \, \sigma &gt; 0\)</span>, with an extra parameter <code>min_xi</code> enabling a prior lower bound to be set for <span class="math inline">\(\xi\)</span>. The same prior can be set, using an in-built prior function, using <code><a href="../reference/set_prior.html">set_prior(prior = "flat", model = "gp", min_xi = -1)</a></code>, where we have set <code>min_xi = -1</code>. Note that . Hence in <code>user_gp_flat</code> <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(\xi\)</span> are <code>x[0]</code> and <code>x[1]</code> not <code>x[1]</code> and <code>x[2]</code>.</p>
<pre><code>// [[Rcpp::depends(Rcpp)]]

#include &lt;Rcpp.h&gt;

using namespace Rcpp;

// [[Rcpp::interfaces(r, cpp)]]

// Generalized Pareto log-priors

// [[Rcpp::export]]
double user_gp_flat(const Rcpp::NumericVector&amp; x, const Rcpp::List&amp; ppars) {
  double min_xi = ppars["min_xi"] ;
  if (x[0] &lt;= 0 || x[1] &lt; min_xi)
    return R_NegInf ;
  return -log(x[0]) ;
}

// [[Rcpp::export]]
SEXP create_prior_xptr(std::string fstr) {
  typedef double (*priorPtr)(const Rcpp::NumericVector&amp; x,
                  const Rcpp::List&amp; ppars) ;
  if (fstr == "gp_flat") 
    return(Rcpp::XPtr&lt;priorPtr&gt;(new priorPtr(&amp;user_gp_flat))) ;
  else
    return(Rcpp::XPtr&lt;priorPtr&gt;(R_NilValue)) ;
}

// We could create an external pointer when this file is sourced using
// this embedded R code below and/or (re)create them using the relevant
// pointer-creation functions in an R session or R package.

/*** R
  ptr_gp_flat &lt;- create_prior_xptr("gp_flat")
*/</code></pre>
<p>Once the external pointer to the user-supplied prior C++ function has been created it is passed to <code>set_prior</code>, along with any required parameter values. The following example repeats the example in <a href="#gp_example">Generalised Pareto (GP) model</a>. The difference is that now we create the pointer <code>ptr_gp_flat</code> and pass it to <code>set_prior</code> using <code>prior = ptr_gp_flat</code> rather than using the arguments <code>prior = "flat", model = "gp"</code> to specify the equivalent in-built prior.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># GP model, user-defined prior</span>
ptr_gp_flat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_prior_xptr.html">create_prior_xptr</a></span>(<span class="st">"gp_flat"</span>)
p_user &lt;-<span class="st"> </span><span class="kw"><a href="../reference/set_prior.html">set_prior</a></span>(<span class="dt">prior =</span> ptr_gp_flat, <span class="dt">model =</span> <span class="st">"gp"</span>, <span class="dt">min_xi =</span> <span class="op">-</span><span class="dv">1</span>)
gpg &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rpost_rcpp.html">rpost_rcpp</a></span>(<span class="dt">n =</span> <span class="dv">1000</span>, <span class="dt">model =</span> <span class="st">"gp"</span>, <span class="dt">prior =</span> p_user, <span class="dt">thresh =</span> u,
                  <span class="dt">data =</span> gom)</code></pre></div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<script type="text/x-mathjax-config">
   MathJax.Hub.Config({  "HTML-CSS": { minScaleAdjust: 125, availableFonts: [] }  });
</script><div id="refs" class="references">
<div id="ref-RcppDEbook">
<p>Eddelbuettel, D. 2013. <em>Seamless R and C++ Integration with Rcpp</em>. New York: Springer. <a href="http://www.springer.com/gb/book/9781461468677" class="uri">http://www.springer.com/gb/book/9781461468677</a>.</p>
</div>
<div id="ref-Rcpp">
<p>Eddelbuettel, D., and R. Francois. 2011. “Rcpp: Seamless R and C++ Integration.” <em>Journal of Statistical Software</em> 40 (8): 1–18. doi:<a href="https://doi.org/10.18637/jss.v040.i08">10.18637/jss.v040.i08</a>.</p>
</div>
<div id="ref-microbenchmark">
<p>Mersmann, O. 2015. <em>Microbenchmark: Accurate Timing Functions</em>. <a href="https://CRAN.R-project.org/package=microbenchmark" class="uri">https://CRAN.R-project.org/package=microbenchmark</a>.</p>
</div>
<div id="ref-rust">
<p>Northrop, P. J. 2017. <em>rust: Ratio-of-Uniforms Simulation with Transformation</em>. <a href="https://CRAN.R-project.org/package=rust" class="uri">https://CRAN.R-project.org/package=rust</a>.</p>
</div>
<div id="ref-coda">
<p>Plummer, M., N. Best, K. Cowles, and K. Vines. 2006. “CODA: Convergence Diagnosis and Output Analysis for MCMC.” <em>R News</em> 6 (1): 7–11. <a href="https://www.r-project.org/doc/Rnews/Rnews_2006-1.pdf" class="uri">https://www.r-project.org/doc/Rnews/Rnews_2006-1.pdf</a>.</p>
</div>
<div id="ref-evdbayes">
<p>Stephenson, A., and M. Ribatet. 2014. <em>evdbayes: Bayesian Analysis in Extreme Value Theory</em>. <a href="https://CRAN.R-project.org/package=evdbayes" class="uri">https://CRAN.R-project.org/package=evdbayes</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#performance-comparisons">Performance comparisons</a></li>
      <li><a href="#cpp_fun">Providing a user-defined prior</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Paul J. Northrop.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
